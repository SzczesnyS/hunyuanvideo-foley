---
import type { Author } from "../types/types";

interface Props {
  authors: Author[];
}

const { authors } = Astro.props;

// 根据作者的notes推断机构列表和编号映射
// 从作者的notes中提取数字编号，对应机构
const institutionMap = new Map<number, string>();

// 遍历作者，根据notes和institution建立映射
authors.forEach(author => {
  if (author.notes && author.institution) {
    // 提取notes中的数字编号
    const numbers = author.notes.flatMap(note => 
      note.split(',').map(n => n.trim()).filter(n => /^\d+$/.test(n)).map(Number)
    );
    
    if (numbers.length > 0) {
      // 如果机构包含逗号，按逗号分割
      const institutions = author.institution.split(',').map(inst => inst.trim());
      
      // 将编号和机构对应起来
      numbers.forEach((num, index) => {
        if (institutions[index]) {
          institutionMap.set(num, institutions[index]);
        } else if (institutions.length === 1) {
          // 如果只有一个机构但有多个编号，该机构对应所有编号
          institutionMap.set(num, institutions[0]);
        }
      });
    }
  }
});

// 按编号排序获取机构列表
const sortedInstitutions = Array.from(institutionMap.entries()).sort((a, b) => a[0] - b[0]);
---

<div class="flex flex-col items-center gap-4">
  <!-- 作者列表 -->
  <div class="flex flex-row gap-x-6 gap-y-3 flex-wrap justify-center">
    {
      authors.map((author) => (
        <span class="text-lg flex flex-row items-center">
          {author.url ? (
            <a href={author.url} class="">
              {author.name}
            </a>
          ) : (
            author.name
          )}
          {author.notes && (
            <sup class="text-sm ml-1">
              {author.notes.map(
                (note, index, array) =>
                  note + (index < array.length - 1 ? "," : "")
              )}
            </sup>
          )}
        </span>
      ))
    }
  </div>
  
  <!-- 机构列表 -->
  {sortedInstitutions.length > 0 && (
    <div class="text-center text-base text-gray-600 dark:text-gray-400">
      {sortedInstitutions.map(([number, institution], index) => (
        <span>
          <sup class="mr-1">{number}</sup>
          {institution}
          {index < sortedInstitutions.length - 1 && <span class="mx-4">&nbsp;&nbsp;&nbsp;</span>}
        </span>
      ))}
    </div>
  )}
</div>
