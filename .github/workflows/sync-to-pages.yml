name: Sync to Pages Repository

on:
  push:
    branches: ["main"]
    paths:
      - 'src/**'
      - 'public/**'
      - 'astro.config.mjs'
      - 'package.json'
      - 'package-lock.json'
      - 'tailwind.config.mjs'
      - 'tsconfig.json'
      - 'svelte.config.js'
      - '.github/workflows/astro.yml'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Clone pages repository
        run: |
          git clone https://${{ secrets.PAGES_TOKEN }}@github.com/SzczesnyS/hunyuanvideo-foley.git pages-repo

      - name: Copy website files
        run: |
          # æ¸…ç©ºç›®æ ‡ä»“åº“ï¼ˆä¿ç•™.gitï¼‰
          find pages-repo -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          # å¤åˆ¶ç½‘é¡µç›¸å…³æ–‡ä»¶
          cp -r src/ pages-repo/
          cp -r public/ pages-repo/
          cp astro.config.mjs pages-repo/
          cp package.json pages-repo/
          cp package-lock.json pages-repo/
          cp tailwind.config.mjs pages-repo/
          cp tsconfig.json pages-repo/
          cp svelte.config.js pages-repo/
          
          # å¤åˆ¶å¿…è¦çš„é…ç½®æ–‡ä»¶
          cp .gitignore pages-repo/ 2>/dev/null || echo ".gitignore not found, skipping"
          
          # åˆ›å»ºæˆ–æ›´æ–°README
          echo "# HIFI-Foley Demo" > pages-repo/README.md
          echo "" >> pages-repo/README.md
          echo "è¿™æ˜¯HIFI-Foleyé¡¹ç›®çš„æ¼”ç¤ºç½‘ç«™ã€‚" >> pages-repo/README.md
          echo "" >> pages-repo/README.md
          echo "ğŸ”— [æŸ¥çœ‹æ¼”ç¤ºç½‘ç«™](https://SzczesnyS.github.io/hunyuanvideo-foley)" >> pages-repo/README.md
          echo "" >> pages-repo/README.md
          echo "æœ¬ä»“åº“é€šè¿‡GitHub Actionsè‡ªåŠ¨åŒæ­¥è‡ªä¸»é¡¹ç›®ä»“åº“ã€‚" >> pages-repo/README.md
          echo "" >> pages-repo/README.md
          echo "## é¡¹ç›®ç‰¹æ€§" >> pages-repo/README.md
          echo "- ğŸµ é«˜è´¨é‡éŸ³é¢‘ç”Ÿæˆ" >> pages-repo/README.md
          echo "- ğŸ¬ è§†é¢‘éŸ³æ•ˆåŒæ­¥" >> pages-repo/README.md
          echo "- ğŸš€ å®æ—¶é¢„è§ˆåŠŸèƒ½" >> pages-repo/README.md
          
          # å¤åˆ¶GitHub Actionsé…ç½®
          mkdir -p pages-repo/.github/workflows/
          cp .github/workflows/astro.yml pages-repo/.github/workflows/

      - name: Update Astro config for GitHub Pages
        run: |
          cd pages-repo
          # å¤‡ä»½åŸé…ç½®
          cp astro.config.mjs astro.config.mjs.bak
          
          # æ›´æ–°astro.config.mjsæ·»åŠ siteå’Œbaseé…ç½®
          sed -i '/export default defineConfig({/a\  site: "https://SzczesnyS.github.io",\n  base: "/hunyuanvideo-foley",' astro.config.mjs
          
          echo "Updated astro.config.mjs:"
          head -15 astro.config.mjs

      - name: Commit and push to pages repo
        run: |
          cd pages-repo
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸš€ Sync from main repo: $(date '+%Y-%m-%d %H:%M:%S') - Commit: ${{ github.sha }}"
            git push
          fi

      - name: Summary
        run: |
          echo "âœ… åŒæ­¥å®Œæˆï¼"
          echo "ğŸ“ ç›®æ ‡ä»“åº“: SzczesnyS/hunyuanvideo-foley"
          echo "ğŸŒ ç½‘ç«™åœ°å€: https://SzczesnyS.github.io/hunyuanvideo-foley"
          echo "ğŸ“ è¯·åœ¨ç›®æ ‡ä»“åº“å¯ç”¨GitHub Pages"
